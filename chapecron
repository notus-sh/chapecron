#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

SOURCE_DIR=$(dirname "$0")

source $SOURCE_DIR/src/chapecron/utils.sh
source $SOURCE_DIR/src/chapecron/stack.sh
source $SOURCE_DIR/src/chapecron/middlewares.sh


utils::check_getopt || utils::fail 1 "Enhanced getopt is required"

# Options
VERBOSE=0
HELP=0

SHORT_OPTIONS=hv
LONG_OPTIONS=help,verbose

self::usage() {
	cat <<-USAGE
		chapecron: look after your crons while you are away
		Usage: $0 [-v,--verbose] [-h,--help] [--] COMMAND
		Options:
		  -h,--help     Print this help and exit
		  -v,--verbose  More verbose output
	USAGE
}

PARSED=$(getopt --options=$SHORT_OPTIONS --longoptions=$LONG_OPTIONS --name "$0" -- "$@")
if [[ $? -ne 0 ]]
then
	self::fail 2 "Invalid arguments. Use $0 -h to get help"
fi

eval set -- "$PARSED"

while true; do
	case "$1" in
		-v|--verbose)
			VERBOSE=1
			shift
			;;
		-h|--help)
			HELP=1
			shift
			;;
		--)
			shift
			break
			;;
		*)
			echo "Programming error"
			exit 3
			;;
	esac
done

COMMAND="$@"


[[ $HELP = 1 ]] && self::usage && exit 0
[[ $VERBOSE = 1 ]] && echo "verbose: $VERBOSE, help: $HELP, command: $COMMAND"



eval_command() {
  eval $COMMAND
}


# Build the middleware stack and run it
stack::add chapecron::mktmp
stack::add chapecron::run
stack::add eval_command

stack::run
